{
	"AWSTemplateFormatVersion" : "2010-09-09",
	"Description" : "Template to create an Aerospike cluster",
	"Parameters" : {
		"KeyPair" : {
			"Description" : "Name of the KeyPair that would be used to ssh into the instances",
			"Type" : "AWS::EC2::KeyPair::KeyName",
			"ConstraintDescription" : "Please specify the name of the keypair that you use to login"
		},
        "AerospikeVersion" : {
            "Description" : "Version of Aerospike to deploy",
            "Type" : "String",
            "Default" : "3.6.3",
            "AllowedValues" : [ "3.6.0", "3.6.1", "3.6.2", "3.6.3" ]
        },

		"NumberOfInstances" : {
			"Description" : "Number of instances in the cluster",
			"Type" : "Number",
			"Default" : "4",
            "MinValue" : "1",
            "MaxValue" : "15"
		},

		"InstanceType" : {
			"Description" : "Type of EC2 instance to launch.",
			"Type" : "String",
			"Default" : "m3.large",
			"AllowedValues" : [ "t2.micro", "t2.small", "t2.medium", "t2.large",
								"m3.medium", "m3.large", "m3.xlarge", "m3.2xlarge", 
								"m4.large", "m4.xlarge", "m4.2xlarge", "m4.4xlarge", "m4.10xlarge",
								"c3.large", "c3.xlarge", "c3.2xlarge", "c3.4xlarge", "c3.8xlarge",
								"c4.large", "c4.xlarge", "c4.2xlarge", "c4.4xlarge", "c4.8xlarge",
								"r3.large",	"r3.xlarge", "r3.2xlarge", "r3.4xlarge", "r3.8xlarge",
								"i2.xlarge", "i2.2xlarge", "i2.4xlarge", "i2.8xlarge"
								]
		},
        "EBS" : {
            "Description" : "Size of EBS SSD volume in GB. The volume will attach under /dev/sdg. Limit of 16000. Enter 0 to not use EBS.",
            "Type" : "Number",
            "Default" : "50",
            "MinValue" : "0",
            "MaxValue" : "16000"
        },
        "NamespaceFile" : {
            "Description" : "(Optional) Location of your namespace definition. Must be publically downloadable. Will append file directly to end of aerospike.conf",
            "Type" : "String"
        }
	},

	"Mappings" : {
        "VersionMap" : {
            "3.6.0" : { "Virginia" : "ami-71b1371a" ,
                        "Oregon" : "ami-3f4c5f0f" ,
                        "California" : "ami-d139c295" ,
                        "Ireland" : "ami-8dfcd8fa" ,
                        "Franfurt" : "ami-d61d1ccb" ,
                        "Singapore" : "ami-dc1b108e" ,
                        "Sydney" : "ami-8b3579b1" ,
                        "Tokyo" : "ami-56f17e56" ,
                        "SPaulo" : "ami-b9f57fa4" },
            "3.6.1" : { "Virginia" : "ami-43295126" ,
                        "Oregon" : "ami-bd8b938d" ,
                        "California" : "ami-8daa6dc9" ,
                        "Ireland" : "ami-5b38102c" ,
                        "Franfurt" : "ami-74adae69" ,
                        "Singapore" : "ami-980215ca" ,
                        "Sydney" : "ami-0b4d0431" ,
                        "Tokyo" : "ami-547be654" ,
                        "SPaulo" : "ami-9934a084" },
            "3.6.2" : { "Virginia" : "ami-0d4f0568" ,
                        "Oregon" : "ami-9e1cfaad" ,
                        "California" : "ami-2b6aab6f" ,
                        "Ireland" : "ami-b5bb8bc2" ,
                        "Franfurt" : "ami-02f4f91f" ,
                        "Singapore" : "ami-d4435386",
                        "Sydney" : "ami-e97932d3" ,
                        "Tokyo" : "ami-caea8dca" ,
                        "SPaulo" : "ami-6b198f76" },
            "3.6.3" : { "Virginia" : "ami-e1f9a684" ,
                        "Oregon" : "ami-c60be9f5" ,
                        "California" : "ami-1f1edd5b" ,
                        "Ireland" : "ami-a75967d0" ,
                        "Franfurt" : "ami-7c828e61" ,
                        "Singapore" : "ami-32b7a460" ,
                        "Sydney" : "ami-27f8b21d" ,
                        "Tokyo" : "ami-4e6c004e" ,
                        "SPaulo" : "ami-0b893167" }
        },
        "RegionMap" : {
            "us-east-1" : {"name": "Virginia"},
            "us-west-2" : {"name": "Oregon"},
            "us-west-1" : {"name": "California"},
            "eu-west-1" : {"name": "Ireland"},
            "eu-central-1" : {"name" : "Franfurt"},
            "ap-southeast-1" : {"name": "Singapore"},
            "ap-southeast-2" : {"name": "Sydney"},
            "ap-northeast-1" : {"name": "Tokyo"},
            "sa-east-1" : {"name": "SPaulo"}
        }
    },
    
    "Conditions" : {
        "NotUsingEBS" : { "Fn::Equals" : [ { "Ref" : "EBS" }, 0  ] },
        "UsingEBS" : { "Fn::Not" : [ { "Fn::Equals" : [ { "Ref" : "EBS" }, 0 ]} ] }
    },

	"Resources" : {
		"ClusterRole" : {
			 "Type": "AWS::IAM::Role",
			 "Properties": {
				"AssumeRolePolicyDocument": {
				   "Version" : "2012-10-17",
				   "Statement": [ {
					  "Effect": "Allow",
					  "Principal": {
						 "Service": [ "ec2.amazonaws.com" ]
					  },
					  "Action": [ "sts:AssumeRole" ]
				   } ]
				},
				"Path": "/",
				"Policies": [ {
				   "PolicyName": "AerospikeClusterPolicy",
				   "PolicyDocument": {
					  "Version" : "2012-10-17",
					  "Statement": [ {
						 "Effect": "Allow",
						 "Action": "ec2:DescribeInstances",
						 "Resource": "*"
					  } ]
				   }
				} ]
			}
		},

		"ClusterInstanceProfile": {
			 "Type": "AWS::IAM::InstanceProfile",
			 "Properties": {
				"Path": "/",
				"Roles": [ {
				   "Ref": "ClusterRole"
				} ]
			 }
		},

		

		"ClusterGroup" : {
			"Type" : "AWS::AutoScaling::AutoScalingGroup",
			"DependsOn" : "GatewayToInternet",
			"Properties" : {
				"LaunchConfigurationName" : { "Fn::If" : [ "NotUsingEBS", { "Ref" : "LaunchConfig" }, { "Ref" : "EBSLaunchConfig" } ] },
				"DesiredCapacity" : { "Ref" : "NumberOfInstances"},
				"MinSize" : "1",
				"MaxSize" : "15",
				"AvailabilityZones" : [ { "Fn::Select" : [ "0", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } } ] } ],
				"VPCZoneIdentifier" : [{ "Ref" : "PublicSubnet" }],
				"Tags" : [ {"Key" : "StackID", "Value" : { "Ref" : "AWS::StackId"}, "PropagateAtLaunch" : "true" } ]
			}
		},
        "LaunchConfig" : {
            "Type" : "AWS::AutoScaling::LaunchConfiguration",
            "DependsOn" : "GatewayToInternet",
            "Condition" : "NotUsingEBS",
            "Metadata" : {
                "AWS::CloudFormation::Init" : {
                    "config" : {
                        "files" : {
                            "/tmp/aerospike_cluster" : {
                                "content" : {  "Fn::Join" : ["", [ 
                                   "#!/bin/bash\n",
                                   "echo ClusterInstancesScriptStart > /var/log/awsuserdatascript\n",
                                   "  PUBLICIP=$(curl http://169.254.169.254/latest/meta-data/public-ipv4)\n",
                                   "  CONF=/etc/aerospike/aerospike.conf\n",
                                   "  sed -i \"/port 3000/a \\\t\taccess-address $PUBLICIP virtual\" $CONF\n",
                                   "  ###Point to all instances using the mesh-address config option\n",
                                   "  PRIVATEIP=$(aws ec2 describe-instances --filter Name=tag-key,Values=StackID Name=tag-value,Values=", { "Ref" : "AWS::StackId" }," --output=text --region=",{ "Ref" : "AWS::Region" }," | grep PRIVATEIPADDRESSES | awk '{print $4}') \n",
                                   "  echo $PRIVATEIP >> /var/log/awsuserdatascript\n",
                                   "  sed -i '/.*mesh-seed-address-port/d' $CONF\n",
                                   "  for i in $PRIVATEIP; do ",
                                   "    sed -i \"/interval/i \\\t\tmesh-seed-address-port $i 3002\" $CONF\n",
                                   "  done \n",
                                   "  if [ ! -z \"",{ "Ref" :"NamespaceFile" },"\" ]; then\n",
                                   "    curl -s ",{ "Ref" :"NamespaceFile" }," >> $CONF; fi\n",
                                   "  /etc/init.d/aerospike start\n",
                                   "  /etc/init.d/amc start\n",
                                   "echo OtherInstancesScriptFinish >> /var/log/awsuserdatascript\n"
                                 ] ] },
                                "mode" : "000744",
                                "owner" : "root",
                                "group" : "root"
                            }
                        },
                        "commands" : {
                            "01_form_asd_cluster" : {
                                "command" : "/tmp/aerospike_cluster",
                                "cwd" : "/tmp"
                            }
                        }
                    }
                }
            },
            "Properties" : {
                "InstanceType" : { "Ref" : "InstanceType"},
                "KeyName" : { "Ref" : "KeyPair" },
                "IamInstanceProfile" : { "Ref" : "ClusterInstanceProfile" },
                "ImageId" : { "Fn::FindInMap" : [ "VersionMap",  {"Ref" : "AerospikeVersion"} , { "Fn::FindInMap" : [ "RegionMap", { "Ref": "AWS::Region"}, "name"] } ] },
                "AssociatePublicIpAddress" : "true",
                "SecurityGroups" : [ { "Ref" : "InstanceSecurityGroup" } ],
                "UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash -xe\n",
                    "yum update -y aws-cfn-bootstrap\n",

                    "/opt/aws/bin/cfn-init -v ",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource LaunchConfig ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n",

                    "/opt/aws/bin/cfn-signal -e $? ",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource ClusterGroup ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n"
                    ] ] }
                }
            }
        },

		"EBSLaunchConfig" : {
			"Type" : "AWS::AutoScaling::LaunchConfiguration",
			"DependsOn" : "GatewayToInternet",
            "Condition" : "UsingEBS",
            "Metadata" : {
                "AWS::CloudFormation::Init" : {
                    "config" : {
                        "files" : {
                            "/tmp/aerospike_cluster" : {
                                "content" : {  "Fn::Join" : ["", [
                                   "#!/bin/bash\n",
                                   "echo ClusterInstancesScriptStart > /var/log/awsuserdatascript\n",
                                   "  PUBLICIP=$(curl http://169.254.169.254/latest/meta-data/public-ipv4)\n",
                                   "  CONF=/etc/aerospike/aerospike.conf\n",
                                   "  sed -i \"/port 3000/a \\\t\taccess-address $PUBLICIP virtual\" $CONF\n",
                                   "  ###Point to all instances using the mesh-address config option\n",
                                   "  PRIVATEIP=$(aws ec2 describe-instances --filter Name=tag-key,Values=StackID Name=tag-value,Values=", { "Ref" : "AWS::StackId" }," --output=text --region=",{ "Ref" : "AWS::Region" }," | grep PRIVATEIPADDRESSES | awk '{print $4}') \n",
                                   "  echo $PRIVATEIP >> /var/log/awsuserdatascript\n",
                                   "  sed -i '/.*mesh-seed-address-port/d' $CONF\n",
                                   "  for i in $PRIVATEIP; do ",
                                   "    sed -i \"/interval/i \\\t\tmesh-seed-address-port $i 3002\" $CONF\n",
                                   "  done \n",
                                   "  if [ ! -z \"",{ "Ref" :"NamespaceFile" },"\" ]; then\n",
                                   "    curl -s ",{ "Ref" :"NamespaceFile" }," >> $CONF; fi\n",
                                   "  /etc/init.d/aerospike start\n",
                                   "  /etc/init.d/amc start\n",
                                   "echo OtherInstancesScriptFinish >> /var/log/awsuserdatascript\n"
                                 ] ] },
                                "mode" : "000744",
                                "owner" : "root",
                                "group" : "root"
                            }
                        },
                        "commands" : {
                            "01_form_asd_cluster" : {
                                "command" : "/tmp/aerospike_cluster",
                                "cwd" : "/tmp"
                            }
                        }
                    }
                }
            },
			"Properties" : {
				"InstanceType" : { "Ref" : "InstanceType"},
				"KeyName" : { "Ref" : "KeyPair" },
                "BlockDeviceMappings" : [ {
                    "DeviceName" : "/dev/sdg",
                    "Ebs" : { "VolumeSize" : {"Ref" : "EBS" },
                             "VolumeType" : "gp2" }
                }],
				"IamInstanceProfile" : { "Ref" : "ClusterInstanceProfile" },
				"ImageId" : { "Fn::FindInMap" : [ "VersionMap",  {"Ref" : "AerospikeVersion"} , { "Fn::FindInMap" : [ "RegionMap", { "Ref": "AWS::Region"}, "name"] } ] },
				"AssociatePublicIpAddress" : "true",
				"SecurityGroups" : [ { "Ref" : "InstanceSecurityGroup" } ],
				"UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
                    "#!/bin/bash -xe\n",
                    "yum update -y aws-cfn-bootstrap\n",

                    "/opt/aws/bin/cfn-init -v ",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource EBSLaunchConfig ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n",

                    "/opt/aws/bin/cfn-signal -e $? ",
                    "         --stack ", { "Ref" : "AWS::StackName" },
                    "         --resource ClusterGroup ",
                    "         --region ", { "Ref" : "AWS::Region" }, "\n"
					] ] }
				}
			}
		},

		"VPC" : {
			"Type" : "AWS::EC2::VPC",
			"Properties" : {
				"CidrBlock" : "10.0.0.0/16",
				"EnableDnsSupport" : "true",
				"EnableDnsHostnames" : "true",
				"Tags" : [ {"Key" : "StackID", "Value" : { "Ref" : "AWS::StackId"} } ]
			}
		},

		"PublicSubnet" : {
			"Type" : "AWS::EC2::Subnet",
			"Properties" : {
				"VpcId" : { "Ref" : "VPC" },
				"CidrBlock" : "10.0.0.0/24",
				"AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : { "Ref" : "AWS::Region" } } ] },
				"Tags" : [ {"Key" : "StackID", "Value" : { "Ref" : "AWS::StackId"} } ]
			}
		},

		"InternetGateway" : {
			"Type" : "AWS::EC2::InternetGateway",
			"Properties" : {
				"Tags" : [ {"Key" : "StackID", "Value" : { "Ref" : "AWS::StackId"} } ]
			}
		},

		"GatewayToInternet" : {
			"Type" : "AWS::EC2::VPCGatewayAttachment",
			"Properties" : {
				"VpcId" : { "Ref" : "VPC" },
				"InternetGatewayId" : { "Ref" : "InternetGateway" }
			}
		},

		"PublicRouteTable" : {
			"Type" : "AWS::EC2::RouteTable",
			"Properties" : {
				"VpcId" : { "Ref" : "VPC" },
				"Tags" : [ {"Key" : "StackID", "Value" : { "Ref" : "AWS::StackId"} } ]
			}
		},

		"PublicRoute" : {
			"Type" : "AWS::EC2::Route",
			"DependsOn" : "GatewayToInternet",
			"Properties" : {
				"RouteTableId" : { "Ref" : "PublicRouteTable" },
				"DestinationCidrBlock" : "0.0.0.0/0",
				"GatewayId" : { "Ref" : "InternetGateway" }
			}
		},

		"PublicSubnetRouteTableAssociation" : {
			"Type" : "AWS::EC2::SubnetRouteTableAssociation",
			"Properties" : {
				"SubnetId" : { "Ref" : "PublicSubnet" },
				"RouteTableId" : { "Ref" : "PublicRouteTable" }
			}
		},

		"InstanceSecurityGroup" : {
			"Type" : "AWS::EC2::SecurityGroup",
			"Properties" : {
				"GroupDescription" : "Enable ports needed by Aerospike",
				"VpcId" : { "Ref" : "VPC" },
				"SecurityGroupIngress" : [ {
					"IpProtocol" : "tcp",
					"FromPort" : "3000",
					"ToPort" : "3000",
					"CidrIp" : "0.0.0.0/0"
				},
				{
					"IpProtocol" : "tcp",
					"FromPort" : "3001",
					"ToPort" : "3004",
					"CidrIp" : "10.0.0.0/16"

				},
				{
					"IpProtocol" : "tcp",
					"FromPort" : "8081",
					"ToPort" : "8081",
					"CidrIp" : "0.0.0.0/0"

				},
				{
					"IpProtocol" : "icmp",
					"FromPort" : "-1",
					"ToPort" : "-1",
					"CidrIp" : "0.0.0.0/0"
				} ],
				"Tags" : [ {"Key" : "StackID", "Value" : { "Ref" : "AWS::StackId"} } ]
			}
		}
	}
}
